<!DOCTYPE html>
<html>
<head>
    <title>Carte Interactive - Agence Immobilière</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
        #form-container {
            position: absolute;
            top: 10px;
            left: 10px;
            background: white;
            padding: 10px;
            border-radius: 5px;
            box-shadow: 0px 0px 10px rgba(0, 0, 0, 0.1);
        }
    </style>
</head>
<body>
    <h2>Carte des maisons prospectées</h2>
    <div id="map" style="width: 100%; height: 600px;"></div>
    
    <div id="form-container">
        <h3>Ajouter un bien</h3>
        <form id="property-form">
            <label>Adresse:</label> <input type="text" id="adresse" required><br>
            <label>Latitude:</label> <input type="text" id="latitude" required><br>
            <label>Longitude:</label> <input type="text" id="longitude" required><br>
            <label>Date Prospection:</label> <input type="date" id="date_prospection" required><br>
            <label>Agent:</label> <input type="text" id="agent" required><br>
            <label>Prix Estimé:</label> <input type="number" id="prix_estime" required><br>
            <label>Prix Client:</label> <input type="number" id="prix_client" required><br>
            <label>Notes:</label> <input type="text" id="notes"><br>
            <button type="submit">Ajouter</button>
        </form>
    </div>

    <script>
        var map = L.map('map').setView([43.3425, 5.4101], 12);

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; OpenStreetMap contributors'
        }).addTo(map);

        var sheetURL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQaxFwdOqv8LQIyfvZyhH6Fow9EgwyZB5NaH6wHQed6J4TeW0CiJheGOv_kkfctHI3WukbMBGM9X5v6/pub?output=csv';

        fetch(sheetURL)
            .then(response => response.text())
            .then(csvText => {
                let rows = csvText.split("\n").slice(1);
                rows.forEach(row => {
                    let cols = row.split(/,(?=(?:[^"']*['"][^"']*['"])*[^"']*$)/);
                    if (cols.length < 8) return;

                    let adresse = cols[0]?.trim();
                    let lat = parseFloat(cols[1].trim());
                    let lng = parseFloat(cols[2].trim());
                    let date_prospection = cols[3]?.trim();
                    let agent = cols[4]?.trim();
                    let prix_estime = cols[5]?.replace(/[^0-9]/g, "").trim();
                    let prix_client = cols[6]?.replace(/[^0-9]/g, "").trim();
                    let notes = cols[7]?.trim();

                    if (!isNaN(lat) && !isNaN(lng)) {
                        let marker = L.marker([lat, lng]).addTo(map);
                        let popupContent = `
                            <div style="font-size: 14px;">
                                <b>📍 Adresse :</b> ${adresse} <br>
                                <b>📅 Date de prospection :</b> ${date_prospection} <br>
                                <b>👤 Agent :</b> ${agent} <br>
                                <b>💰 Prix estimé :</b> ${prix_estime} € <br>
                                <b>💲 Prix demandé :</b> ${prix_client} € <br>
                                <b>📝 Notes :</b> ${notes}
                            </div>
                        `;
                        marker.bindPopup(popupContent);
                    }
                });
            })
            .catch(error => console.error('Erreur de chargement des données:', error));

        document.getElementById("property-form").addEventListener("submit", function(event) {
            event.preventDefault();
            
            var formData = new FormData();
            formData.append("adresse", document.getElementById("adresse").value);
            formData.append("latitude", document.getElementById("latitude").value);
            formData.append("longitude", document.getElementById("longitude").value);
            formData.append("date_prospection", document.getElementById("date_prospection").value);
            formData.append("agent", document.getElementById("agent").value);
            formData.append("prix_estime", document.getElementById("prix_estime").value);
            formData.append("prix_client", document.getElementById("prix_client").value);
            formData.append("notes", document.getElementById("notes").value);

            fetch('https://script.google.com/macros/s/AKfycbyiEsT-JyCu-pbkOpoyODpPgksUjaYmIkmJkXmAqDurEecoJqOBqHTL7cXA2KosyoIIDQ/exec', {
                method: "POST",
                body: formData
            }).then(response => response.json())
            .then(data => {
                alert("Bien ajouté avec succès!");
                location.reload();
            })
            .catch(error => console.error('Erreur lors de l'ajout:', error));
        });
    </script>
</body>
</html>
